<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script>
			var cars = {};
			var map;
			$(function(){
			    var myLatlng = new google.maps.LatLng(-34.397, 150.644);
			    var myOptions = {
			        zoom: 8,
			        center: myLatlng,
			        mapTypeId: google.maps.MapTypeId.ROADMAP
			    }
			    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				$.getJSON('/api/route', {id: 17}, function(route) {
					var bounds = new google.maps.LatLngBounds();
					var pathPoints = $.map(route.path, function(point) {
						var coord = new google.maps.LatLng(point.lat, point.lng);
						console.log(point, coord);
						bounds.extend(coord);
						return coord;
					});
					console.log(bounds);
					var path = new google.maps.Polyline({
					    path: pathPoints,
					    strokeColor: "#0000FF",
					    strokeOpacity: 1.0,
					    strokeWeight: 2
					});
					path.setMap(map);
					map.fitBounds(bounds);
					window.setInterval(updateCarPositions, 2000);
				});
			});
			function updateCarPositions() {
				$.get('/api/cars', {id: 17}, function(carPositions) {
					$.each(carPositions, function(i,car) {
						var pos = new google.maps.LatLng(car.lat, car.lng);
						console.log(pos);
						if (cars[car.id]) {
							cars[car.id].setPosition(pos);
						}
						else {
							cars[car.id] = new google.maps.Marker({
							      position: pos,
							      map: map,
							      title: "18"
						    });
						}
					});
				});
			}
		</script>
		<style type="text/css">
			html {height:100%;}
      		body {margin:0; padding:0; height:100%;}
      		#map_canvas { height:100% }
		</style>
	</head>
	<body>
		<div id="map_canvas"></div>
	</body>
</html>