<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script>
			var cars = {};
			var stops = [];
			var map;
			$(function(){
				$.getJSON('/api/route', {id: 17}, function(route) {
				    var myOptions = {
				        mapTypeId: google.maps.MapTypeId.ROADMAP
				    }
				    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
					var bounds = new google.maps.LatLngBounds();
					var pathPoints = $.map(route.path, function(point) {
						var coord = new google.maps.LatLng(point.lat, point.lng);
						console.log(point, coord);
						bounds.extend(coord);
						return coord;
					});
					console.log(bounds);
					var path = new google.maps.Polyline({
					    path: pathPoints,
					    strokeColor: "#0000FF",
					    strokeOpacity: 1.0,
					    strokeWeight: 2
					});
					var stopIcon = {
						url: '/images/stop.png',
						size: new google.maps.Size(32, 37),
						anchor: new google.maps.Point(16, 35)
					};
					$.each(route.stops, function(i, stop) {
						stops.push(new google.maps.Marker({
						      position: new google.maps.LatLng(stop.lat, stop.lng),
						      map: map,
						      title: stop.id,
						      icon: stopIcon,
						      zIndex: -1,
						      visible: false
					    }));
					});
					path.setMap(map);
					map.fitBounds(bounds);
					window.setInterval(updateCarPositions, 2000);
					google.maps.event.addListener(map, 'zoom_changed', function() {
						console.log(map.getZoom());
						var visible = map.getZoom() > 14;
						$.each(stops, function(i, s) { s.setVisible(visible); });
					});
				});
			});
			function updateCarPositions() {
				$.get('/api/cars', {id: 17}, function(carPositions) {
					$.each(carPositions, function(i,car) {
						var pos = new google.maps.LatLng(car.lat, car.lng);
						var icon = {
							url: '/images/bus_'+ (car.forward ? 'forward' : 'backward') +'.png',
							size: new google.maps.Size(32, 32),
							anchor: new google.maps.Point(16, 24)
						};
						if (cars[car.id]) {
							cars[car.id].setPosition(pos);
							cars[car.id].setIcon(icon);
						}
						else {
							cars[car.id] = new google.maps.Marker({
							      position: pos,
							      map: map,
							      title: "18",
							      icon: icon
						    });
						}
					});
				});
			}
		</script>
		<style type="text/css">
			html {
				height:100%;
			}
      		body {
      			margin: 0; 
      			padding: 0; 
      			height: 100%;
   			}
      		#map_canvas { 
      			height: 100% 
      		}
      		input:focus {
			    outline: 0 none;
			}
			textarea:focus {
			    outline: 0 none;
			}
		</style>
	</head>
	<body>
		<div id="map_canvas"></div>
	</body>
</html>